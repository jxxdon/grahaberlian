<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pembelian | Graha Berlian</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="global.css">
</head>

<body>

<div class="content">

  <div class="card">
    <h3>Input Pembelian</h3>

    <label>Tanggal</label>
    <input type="date" id="date">

    <input id="invoice" placeholder="No Invoice" readonly>

    <label>Supplier</label>
    <input type="text" id="supplierSearch" placeholder="Cari supplier...">
    <div id="supplierResult" class="search-result"></div>

    <label>Produk</label>
    <input type="text" id="productSearch" placeholder="Cari produk...">
    <div id="productResult" class="search-result"></div>

    <input type="number" id="qty" placeholder="Qty">
    <input type="number" id="price" placeholder="Harga Satuan">
    <input type="number" id="total" placeholder="Total" readonly>

    <input type="number" id="dp" placeholder="Jumlah Dibayar (DP)">
    <input type="number" id="remaining" placeholder="Sisa Bayar" readonly>

    <label>Akun Bayar</label>
    <select id="accountSelect">
      <option value="">Pilih Akun</option>
    </select>

    <textarea id="note" placeholder="Keterangan"></textarea>

    <button id="saveBtn">Simpan</button>
  </div>

  <div class="card">
    <h3>Daftar Pembelian</h3>
    <div id="list"></div>
  </div>

</div>

<script type="module" src="./auth-guard.js"></script>

<script type="module">
import { loadLayout } from "./layout.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  updateDoc,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

loadLayout("Pembelian");

const db = getFirestore();

const qtyInput = document.getElementById("qty");
const priceInput = document.getElementById("price");
const totalInput = document.getElementById("total");
const dpInput = document.getElementById("dp");
const remainingInput = document.getElementById("remaining");
const accountSelect = document.getElementById("accountSelect");

let selectedSupplier = null;
let selectedProduct = null;
let accounts = [];

// ====================
// HITUNG TOTAL
// ====================
function calculateTotal() {
  const qty = Number(qtyInput.value) || 0;
  const price = Number(priceInput.value) || 0;
  const total = qty * price;
  totalInput.value = total;

  const dp = Number(dpInput.value) || 0;
  remainingInput.value = total - dp;
}

qtyInput.addEventListener("input", calculateTotal);
priceInput.addEventListener("input", calculateTotal);
dpInput.addEventListener("input", calculateTotal);

// ====================
// LOAD ACCOUNTS
// ====================
async function loadAccounts(){
  const snap = await getDocs(collection(db, "accounts"));
  accounts = [];

  accountSelect.innerHTML = `<option value="">Pilih Akun</option>`;

  snap.forEach(docSnap=>{
    const d = docSnap.data();
    accounts.push({
      id: docSnap.id,
      name: d.name,
      balance: d.balance || 0
    });

    accountSelect.innerHTML += `
      <option value="${docSnap.id}">
        ${d.name} (Rp ${Number(d.balance).toLocaleString("id-ID")})
      </option>
    `;
  });
}

// ====================
// UPDATE SALDO AKUN
// ====================
async function reduceAccountBalance(accountId, amount){

  const account = accounts.find(a => a.id === accountId);
  if(!account) return;

  const newBalance = account.balance - amount;

  await updateDoc(doc(db, "accounts", accountId), {
    balance: newBalance
  });
}

// ====================
// SIMPAN PEMBELIAN
// ====================
document.getElementById("saveBtn").addEventListener("click", async ()=>{

  const dp = Number(dpInput.value) || 0;
  const accountId = accountSelect.value;

  if(dp > 0 && !accountId){
    alert("Pilih akun bayar");
    return;
  }

  await addDoc(collection(db, "purchases"), {
    date: document.getElementById("date").value,
    supplierName: selectedSupplier?.name || "",
    productName: selectedProduct?.name || "",
    qty: Number(qtyInput.value),
    price: Number(priceInput.value),
    total: Number(totalInput.value),
    dp,
    remaining: Number(remainingInput.value),
    note: document.getElementById("note").value,
    createdAt: new Date()
  });

  // Kurangi saldo akun jika ada pembayaran
  if(dp > 0){
    await reduceAccountBalance(accountId, dp);
  }

  alert("Pembelian berhasil disimpan");

  // Reset form
  qtyInput.value = "";
  priceInput.value = "";
  totalInput.value = "";
  dpInput.value = "";
  remainingInput.value = "";
  accountSelect.value = "";
  document.getElementById("note").value = "";

  loadAccounts();
});

loadAccounts();
</script>

</body>
</html>
