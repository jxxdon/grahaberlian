<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pembelian | Graha Berlian</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="global.css">

<style>
.search-result {
  background: #fff;
  border-radius: 8px;
  margin-top: 4px;
  max-height: 150px;
  overflow-y: auto;
  box-shadow: 0 4px 10px rgba(0,0,0,.08);
}
.search-result div {
  padding: 8px;
  cursor: pointer;
}
.search-result div:hover {
  background: #e0e7ff;
}
</style>
</head>

<body>

<div class="content">

  <div class="card">
    <h3>Input Pembelian</h3>

    <label>Tanggal</label>
    <input type="date" id="date">

    <input id="invoice" placeholder="No Invoice" readonly>

    <label>Supplier</label>
    <input type="text" id="supplierSearch" placeholder="Cari supplier...">
    <div id="supplierResult" class="search-result"></div>

    <label>Produk</label>
    <input type="text" id="productSearch" placeholder="Cari produk...">
    <div id="productResult" class="search-result"></div>

    <input type="number" id="qty" placeholder="Qty">
    <input type="number" id="price" placeholder="Harga Satuan">
    <input type="number" id="total" placeholder="Total" readonly>

    <textarea id="note" placeholder="Keterangan"></textarea>

    <button id="saveBtn">Simpan</button>
  </div>

  <div class="card">
    <h3>Daftar Pembelian</h3>
    <div id="list"></div>
  </div>

</div>

<script type="module" src="./auth-guard.js"></script>

<script type="module">
import { loadLayout } from "./layout.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

loadLayout("Pembelian");

const db = getFirestore();

const qtyInput = document.getElementById("qty");
const priceInput = document.getElementById("price");
const totalInput = document.getElementById("total");

let suppliers = [];
let products = [];
let selectedSupplier = null;
let selectedProduct = null;

// ====================
// DEFAULT TANGGAL
// ====================
document.getElementById("date").value =
  new Date().toISOString().split("T")[0];

// ====================
// GENERATE INVOICE
// ====================
function generateInvoice(){
  const time = Date.now().toString().slice(-6);
  document.getElementById("invoice").value = "PO-" + time;
}
generateInvoice();

// ====================
// HITUNG TOTAL
// ====================
function calculateTotal(){
  const qty = Number(qtyInput.value) || 0;
  const price = Number(priceInput.value) || 0;
  totalInput.value = qty * price;
}
qtyInput.addEventListener("input", calculateTotal);
priceInput.addEventListener("input", calculateTotal);

// ====================
// LOAD SUPPLIERS
// ====================
async function loadSuppliers(){
  const snap = await getDocs(collection(db, "suppliers"));
  suppliers = [];

  snap.forEach(doc=>{
    suppliers.push({
      id: doc.id,
      name: doc.data().companyName || doc.data().name
    });
  });
}

// SEARCH SUPPLIER
const supplierSearch = document.getElementById("supplierSearch");
const supplierResult = document.getElementById("supplierResult");

supplierSearch.addEventListener("input", ()=>{
  const keyword = supplierSearch.value.toLowerCase();
  supplierResult.innerHTML = "";

  suppliers
    .filter(s => s.name.toLowerCase().includes(keyword))
    .slice(0,10)
    .forEach(s=>{
      const div = document.createElement("div");
      div.textContent = s.name;
      div.onclick = ()=>{
        selectedSupplier = s;
        supplierSearch.value = s.name;
        supplierResult.innerHTML = "";
      };
      supplierResult.appendChild(div);
    });
});

// ====================
// LOAD PRODUCTS
// ====================
async function loadProducts(){
  const snap = await getDocs(collection(db, "products"));
  products = [];

  snap.forEach(doc=>{
    const d = doc.data();
    products.push({
      id: doc.id,
      name: d.name,
      price: d.price || 0
    });
  });
}

// SEARCH PRODUCT
const productSearch = document.getElementById("productSearch");
const productResult = document.getElementById("productResult");

productSearch.addEventListener("input", ()=>{
  const keyword = productSearch.value.toLowerCase();
  productResult.innerHTML = "";

  products
    .filter(p => p.name.toLowerCase().includes(keyword))
    .slice(0,10)
    .forEach(p=>{
      const div = document.createElement("div");
      div.textContent = p.name;

      div.onclick = ()=>{
        selectedProduct = p;
        productSearch.value = p.name;
        priceInput.value = p.price;
        calculateTotal();
        productResult.innerHTML = "";
      };

      productResult.appendChild(div);
    });
});

// ====================
// SIMPAN
// ====================
document.getElementById("saveBtn").addEventListener("click", async ()=>{

  if(!selectedSupplier || !selectedProduct){
    alert("Pilih supplier dan produk");
    return;
  }

  await addDoc(collection(db, "purchases"), {
  invoice: document.getElementById("invoice").value,
  date: document.getElementById("date").value,
  supplierId: selectedSupplier.id,
  supplierName: selectedSupplier.name,
  productId: selectedProduct.id,
  productName: selectedProduct.name,
  qty: Number(qtyInput.value),
  price: Number(priceInput.value),
  total: Number(totalInput.value),
  paid: 0,
  remaining: Number(totalInput.value),
  status: "Belum Lunas",
  note: document.getElementById("note").value,
  createdAt: new Date()
});


  alert("Pembelian berhasil disimpan");

  // reset form
  supplierSearch.value = "";
  productSearch.value = "";
  qtyInput.value = "";
  priceInput.value = "";
  totalInput.value = "";
  document.getElementById("note").value = "";
  selectedSupplier = null;
  selectedProduct = null;

  generateInvoice();
  loadPurchases();
});

// ====================
// LOAD LIST
// ====================
async function loadPurchases(){

  const listEl = document.getElementById("list");
  listEl.innerHTML = "";

  const q = query(
    collection(db, "purchases"),
    orderBy("createdAt","desc")
  );

  const snap = await getDocs(q);

  snap.forEach(doc=>{
  const d = doc.data();

  listEl.innerHTML += `
    <div class="card" style="padding:12px;">
      <strong>${d.invoice}</strong><br>
      ${d.productName} - ${d.supplierName}<br>
      ðŸ“… ${d.date}<br>
      ðŸ’° Total: Rp ${Number(d.total).toLocaleString("id-ID")}<br>
      ðŸ’³ Dibayar: Rp ${Number(d.paid || 0).toLocaleString("id-ID")}<br>
      ðŸ§¾ Sisa: Rp ${Number(d.remaining || 0).toLocaleString("id-ID")}<br>
      Status: ${d.status}<br>
      ${
        d.remaining > 0
        ? `<button onclick="openPaymentModal('${doc.id}', ${d.remaining})">Catat Pembayaran</button>`
        : ""
      }
    </div>
  `;
});
}

import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

let currentPurchaseId = null;

window.openPaymentModal = async function(id, remaining){
  currentPurchaseId = id;

  document.getElementById("payAmount").value = remaining;

  // load akun
  const snap = await getDocs(collection(db, "accounts"));
  const select = document.getElementById("payAccount");
  select.innerHTML = "";

  snap.forEach(docSnap=>{
    const d = docSnap.data();
    select.innerHTML += `
      <option value="${docSnap.id}">
        ${d.name} (Rp ${Number(d.balance).toLocaleString("id-ID")})
      </option>
    `;
  });

  document.getElementById("paymentModal").style.display = "flex";
}

window.closePaymentModal = function(){
  document.getElementById("paymentModal").style.display = "none";
}

window.savePayment = async function(){

  const amount = Number(document.getElementById("payAmount").value);
  const accountId = document.getElementById("payAccount").value;

  if(!amount || !accountId){
    alert("Lengkapi data");
    return;
  }

  const purchaseRef = doc(db, "purchases", currentPurchaseId);
  const purchaseSnap = await getDocs(query(collection(db, "purchases")));

  // ambil data purchase
  const purchaseDoc = await (await fetch(
    `https://firestore.googleapis.com/v1/projects/YOUR_PROJECT_ID/databases/(default)/documents/purchases/${currentPurchaseId}`
  ));

}

  
loadSuppliers();
loadProducts();
loadPurchases();

</script>
  
<div id="paymentModal" class="modal">
  <div class="modal-content">
    <h3>Catat Pembayaran</h3>
    <input type="number" id="payAmount" placeholder="Nominal Bayar">
    <select id="payAccount"></select>
    <button onclick="savePayment()">Simpan</button>
    <button onclick="closePaymentModal()">Batal</button>
  </div>
</div>

</body>
</html>
