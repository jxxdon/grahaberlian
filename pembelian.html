<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Pembelian | Graha Berlian</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:sans-serif;
  background:#f3f4f6;
  margin:0;
}

.layout{
  max-width:700px;
  margin:auto;
  padding:16px;
}

.card{
  background:white;
  padding:16px;
  border-radius:12px;
  margin-bottom:16px;
  box-shadow:0 4px 10px rgba(0,0,0,.05);
}

input, textarea{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #ddd;
}

button{
  background:#3b82f6;
  color:white;
  border:none;
  padding:10px;
  border-radius:8px;
  width:100%;
}

.btn-mini{
  width:auto;
  padding:6px 10px;
  font-size:13px;
}
</style>
</head>

<body>

<!-- WRAPPER -->
<div id="app"></div>

<!-- MODAL -->
<div id="paymentModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);justify-content:center;align-items:center;">
  <div style="background:white;padding:16px;border-radius:12px;width:90%;max-width:380px;">
    <h3>Catat Pembayaran</h3>
    <input type="number" id="payAmount" placeholder="Jumlah Bayar">
    <button onclick="savePayment()">Simpan</button>
    <button onclick="closePaymentModal()" style="background:#9ca3af;margin-top:8px;">Batal</button>
  </div>
</div>

<script type="module">
import {
  collection,
  addDoc,
  getDocs,
  doc,
  updateDoc,
  getDoc,
  query,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

import { db } from "./firebase.js";

import { loadLayout } from "./layout.js";

/* ================= WRAPPER AKTIF ================= */
loadLayout("Pembelian");

/* Isi konten dimasukkan ke wrapper */
document.getElementById("app").innerHTML += `
<div class="layout">

  <div class="card">
    <h3>Input Pembelian</h3>

    <input type="date" id="date">
    <input id="invoice" readonly placeholder="Invoice">

    <input type="text" id="supplier" placeholder="Supplier">
    <input type="text" id="product" placeholder="Produk">

    <input type="number" id="qty" placeholder="Qty">
    <input type="number" id="price" placeholder="Harga">
    <input type="number" id="total" placeholder="Total" readonly>

    <button id="saveBtn">Simpan</button>
  </div>

  <div class="card">
    <h3>Daftar Pembelian</h3>
    <div id="list"></div>
  </div>

</div>
`;

/* ================= LOGIC ================= */

let currentId=null;

const date=document.getElementById("date");
const invoice=document.getElementById("invoice");
const qty=document.getElementById("qty");
const price=document.getElementById("price");
const total=document.getElementById("total");
const saveBtn=document.getElementById("saveBtn");
const list=document.getElementById("list");

date.value=new Date().toISOString().split("T")[0];
invoice.value="PO-"+Date.now().toString().slice(-6);

function calculate(){
  total.value=(Number(qty.value)||0)*(Number(price.value)||0);
}
qty.addEventListener("input",calculate);
price.addEventListener("input",calculate);

saveBtn.addEventListener("click",async()=>{
  await addDoc(collection(db,"purchases"),{
    invoice:invoice.value,
    date:date.value,
    qty:Number(qty.value),
    price:Number(price.value),
    total:Number(total.value),
    paid:0,
    createdAt:new Date()
  });

  invoice.value="PO-"+Date.now().toString().slice(-6);
  loadData();
});

async function loadData(){
  list.innerHTML="";
  const q=query(collection(db,"purchases"),orderBy("createdAt","desc"));
  const snap=await getDocs(q);

  snap.forEach(docSnap=>{
    const d=docSnap.data();
    const sisa=d.total-(d.paid||0);

    list.innerHTML+=`
      <div class="card">
        <strong>${d.invoice}</strong><br>
        Total: Rp ${d.total}<br>
        Sisa: Rp ${sisa}<br>
        ${
          sisa>0
          ? `<button class="btn-mini" onclick="openPaymentModal('${docSnap.id}',${sisa})">Bayar</button>`
          : `<span style="color:green;font-weight:bold;">Lunas</span>`
        }
      </div>
    `;
  });
}

window.openPaymentModal=function(id,sisa){
  currentId=id;
  document.getElementById("payAmount").value=sisa;
  document.getElementById("paymentModal").style.display="flex";
};

window.closePaymentModal=function(){
  document.getElementById("paymentModal").style.display="none";
};

window.savePayment=async function(){
  const amount=Number(document.getElementById("payAmount").value);
  const ref=doc(db,"purchases",currentId);
  const snap=await getDoc(ref);
  const data=snap.data();

  await updateDoc(ref,{
    paid:(data.paid||0)+amount
  });

  closePaymentModal();
  loadData();
};

loadData();
</script>

</body>
</html>
